<!doctype html>
<html lang="zh-cn">
  <head>
    <title>ELK // hpeng526</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.59.1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="hpeng526" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://hpeng526.github.io/css/main.min.f90f5edd436ec7b74ad05479a05705770306911f721193e7845948fb07fe1335.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ELK"/>
<meta name="twitter:description" content="ELK 搭建与使用 (5.4) ELK 是什么? ElasticSearch &#43; logstash &#43; kibana 是一套开源的日志管理检索方案 我采用的采集流程 &#43;-----------&#43; | | | filebeat1 &#43;------&#43; | | | &#43;-------&#43; &#43;-------------&#43; &#43;-----------------&#43; &#43;----------&#43; &#43;-----------&#43; | | | | | | | | | &#43;--&gt; | redis &#43;--&gt; | logstash &#43;---&gt; |"/>

    <meta property="og:title" content="ELK" />
<meta property="og:description" content="ELK 搭建与使用 (5.4) ELK 是什么? ElasticSearch &#43; logstash &#43; kibana 是一套开源的日志管理检索方案 我采用的采集流程 &#43;-----------&#43; | | | filebeat1 &#43;------&#43; | | | &#43;-------&#43; &#43;-------------&#43; &#43;-----------------&#43; &#43;----------&#43; &#43;-----------&#43; | | | | | | | | | &#43;--&gt; | redis &#43;--&gt; | logstash &#43;---&gt; |" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hpeng526.github.io/posts/17/1706elk/" />
<meta property="article:published_time" content="2017-06-22T23:21:22+00:00" />
<meta property="article:modified_time" content="2017-06-22T23:21:22+00:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://hpeng526.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="hpeng526" /></a>
      <h1>hpeng526</h1>
      <p>Notes</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/hpeng526" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">ELK</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jun 22, 2017
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://hpeng526.github.io/tags/elk/">ELK</a><a class="tag" href="https://hpeng526.github.io/tags/elasticsearch/">ElasticSearch</a><a class="tag" href="https://hpeng526.github.io/tags/logstash/">LogStash</a><a class="tag" href="https://hpeng526.github.io/tags/kibana/">Kibana</a></div></div>
    </header>
    <div class="post-content">
      

<h2 id="elk-搭建与使用-5-4">ELK 搭建与使用 (5.4)</h2>

<h2 id="elk-是什么">ELK 是什么?</h2>

<p>ElasticSearch + logstash + kibana 是一套开源的日志管理检索方案</p>

<h2 id="我采用的采集流程">我采用的采集流程</h2>

<pre><code>+-----------+
|           |
| filebeat1 +------+
|           |      |    +-------+    +-------------+     +-----------------+    +----------+
+-----------+      |    |       |    |             |     |                 |    |          |
                   +--&gt; | redis +--&gt; |  logstash   +---&gt; |  ElasticSearch  +---&gt;+  kibana  |
+-----------+      |    |       |    |             |     |                 |    |          |
|           |      |    +-------+    +-------------+     +-----------------+    +----------+
| filebeat2 +------+
|           |
+-----------+

</code></pre>

<!-- more -->

<p>RPUSH BLPOP</p>

<h3 id="filebeat-采集">filebeat 采集</h3>

<p>一般, filebeat只做简单的采集, 与简单的聚合, 例如多行聚合, 剩下的数据筛选之类的, 都交给后面一层专业的 logstash 处理.</p>

<h4 id="config">config</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">filebeat.prospectors:
- input_type: log
  paths:
    - /alidata/log/tomcat-<span style="color:#ff79c6">*/catalina.out</span>
  multiline.pattern: <span style="color:#f1fa8c">&#39;^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2},[0-9]{3} \[&#39;</span>
  multiline.negate: <span style="color:#ff79c6">true</span>
  multiline.match: after

output.redis:
  hosts: <span style="color:#f1fa8c">&#34;192.168.1.61:6379&#34;</span>
  password: <span style="color:#f1fa8c">&#34;redispwd&#34;</span>
  key: <span style="color:#f1fa8c">&#34;tomcat-catalina-log&#34;</span>
  db: <span style="color:#bd93f9">0</span>
  timeout: <span style="color:#bd93f9">5</span></code></pre></div>
<p>ref:  <a href="https://www.elastic.co/guide/en/beats/filebeat/current/redis-output.html">redis-output</a></p>

<h3 id="redis">redis</h3>

<p>保存在redis上是以队列的形式, 也就是list, 用命令查出来是这样的 <code>lpop tomcat-catalina-log</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#ff79c6">&#34;@timestamp&#34;</span>: <span style="color:#f1fa8c">&#34;2017-06-21T03:40:42.312Z&#34;</span>,
  <span style="color:#ff79c6">&#34;beat&#34;</span>: {
    <span style="color:#ff79c6">&#34;hostname&#34;</span>: <span style="color:#f1fa8c">&#34;front-end&#34;</span>,
    <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;front-end&#34;</span>,
    <span style="color:#ff79c6">&#34;version&#34;</span>: <span style="color:#f1fa8c">&#34;5.4.2&#34;</span>
  },
  <span style="color:#ff79c6">&#34;input_type&#34;</span>: <span style="color:#f1fa8c">&#34;log&#34;</span>,
  <span style="color:#ff79c6">&#34;message&#34;</span>: <span style="color:#f1fa8c">&#34;2017-06-21 11:40:33,572 [ERROR] xxx.xxxxxxx.Logger:87 - org.springframework.dao.DataIntegrityViolationException: SqlMapClient operation; SQL []; Column &#39;FID&#39; cannot be null; nested exception is java.sql.BatchUpdateException: Column &#39;FID&#39; cannot be null\\n\\tat org.springframework.jdbc.support.SQLStateSQLExceptionTranslator.doTranslate(SQLStateSQLExceptionTranslator.java:102)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:73)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:81)\\n\\tat org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:81)\\n\\tat org.springframework.orm.ibatis.SqlMapClientTemplate.execute(SqlMapClientTemplate.java:204)\\n\\tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\\n\\tat java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\\n\\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\\n\\tat java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\\n\\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\\n\\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\\n\\tat java.lang.Thread.run(Thread.java:745)\\n&#34;</span>,
  <span style="color:#ff79c6">&#34;offset&#34;</span>: <span style="color:#bd93f9">29117034</span>,
  <span style="color:#ff79c6">&#34;source&#34;</span>: <span style="color:#f1fa8c">&#34;/alidata/log/tomcat-xxx/catalina.out&#34;</span>,
  <span style="color:#ff79c6">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;log&#34;</span>
}</code></pre></div>
<h3 id="logstash">logstash</h3>

<ul>
<li>首先, <b>不要尝试自己写正则了</b>, java日志与tomcat日志都是很常见的</li>

<li><p>导入配置 <a href="https://github.com/logstash-plugins/logstash-patterns-core">Github-patterns</a></p>

<pre><code>JAVACLASS (?:[a-zA-Z$_][a-zA-Z$_0-9]*\.)*[a-zA-Z$_][a-zA-Z$_0-9]*
#Space is an allowed character to match special cases like 'Native Method' or 'Unknown Source'
JAVAFILE (?:[A-Za-z0-9_. -]+)
#Allow special &lt;init&gt;, &lt;clinit&gt; methods
JAVAMETHOD (?:(&lt;(?:cl)?init&gt;)|[a-zA-Z$_][a-zA-Z$_0-9]*)
#Line number is optional in special cases 'Native method' or 'Unknown source'
JAVASTACKTRACEPART %{SPACE}at %{JAVACLASS:class}\.%{JAVAMETHOD:method}\(%{JAVAFILE:file}(?::%{NUMBER:line})?\)
# Java Logs
JAVATHREAD (?:[A-Z]{2}-Processor[\d]+)
JAVACLASS (?:[a-zA-Z0-9-]+\.)+[A-Za-z0-9$]+
JAVAFILE (?:[A-Za-z0-9_.-]+)
JAVALOGMESSAGE (.*)
# MMM dd, yyyy HH:mm:ss eg: Jan 9, 2014 7:13:13 AM
CATALINA_DATESTAMP %{MONTH} %{MONTHDAY}, 20%{YEAR} %{HOUR}:?%{MINUTE}(?::?%{SECOND}) (?:AM|PM)
# yyyy-MM-dd HH:mm:ss,SSS ZZZ eg: 2014-01-09 17:32:25,527 -0800
TOMCAT_DATESTAMP 20%{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:?%{MINUTE}(?::?%{SECOND})
CATALINALOG %{CATALINA_DATESTAMP:timestamp} %{JAVACLASS:class} %{JAVALOGMESSAGE:logmessage}
# 2014-01-09 20:03:28,269 | ERROR | com.example.service.ExampleService - something compeletely unexpected happened...
TOMCATLOG %{TOMCAT_DATESTAMP:timestamp} \| %{LOGLEVEL:level} \| %{JAVACLASS:class} - %{JAVALOGMESSAGE:logmessage}
</code></pre></li>
</ul>

<p>日志sample</p>

<pre><code>2017-06-21 16:07:35,995 [INFO ] org.apache.logging.log4j.LogManager:409 - 延时加载 key:rights,耗时：142
</code></pre>

<p>上面的配置, 我把TOMCAT_DATESTAMP的timezone去掉了, 因为我们自己的没有时区
logstash 配置文件</p>

<p>匹配失败
tag_on_failure</p>

<h4 id="grok-语法-link-https-www-elastic-co-guide-en-logstash-current-plugins-filters-grok-html">grok 语法 <a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html">LINK</a></h4>

<pre><code>%{IP:client}                  用 pattern IP(自带的或者自定义的) 匹配到的命名为 client
(?&lt;log_msg&gt;.*)                用 pattern .* 匹配到的命名为log_msg
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">input {
	redis {
		data_type =&gt; &#34;list&#34;
		host =&gt; &#34;192.168.1.61&#34;
		port =&gt; 6379
		password =&gt; &#34;redispwd&#34;
		db =&gt; 0
		key =&gt; &#34;tomcat-catalina-log&#34;
	}
}

filter {
	grok {
		patterns_dir =&gt; [&#34;/root/elk/patterns&#34;]
		match =&gt; {
		    &#34;message&#34; =&gt; &#34;(?&lt;log_time&gt;(^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2},[0-9]{3})) \[(?&lt;log_level&gt;([Aa]lert|ALERT|[Tt]race|TRACE|[Dd]ebug|DEBUG|[Nn]otice|NOTICE|[Ii]nfo|INFO|[Ww]arn?(?:ing)?|WARN?(?:ING)?|[Ee]rr?(?:or)?|ERR?(?:OR)?|[Cc]rit?(?:ical)?|CRIT?(?:ICAL)?|[Ff]atal|FATAL|[Ss]evere|SEVERE|EMERG(?:ENCY)?|[Ee]merg(?:ency)?))\s?\] (?&lt;log_class&gt;(?:[a-zA-Z$_][a-zA-Z$_0-9]*\.*)*[a-zA-Z$_][a-zA-Z$_0-9]*):[0-9]* - (?&lt;log_msg&gt;.*)&#34;
		}
		match =&gt; {
			&#34;source&#34; =&gt; &#34;/alidata/log/(?&lt;log_from&gt;.*)/catalina\.out&#34;
		}
		break_on_match =&gt; false
		remove_field =&gt; [&#34;beat&#34;]
	}
	date {
		match =&gt; [&#34;log_time&#34;, &#34;yyyy-MM-dd HH:mm:ss,SSS&#34;]
		timezone =&gt; &#34;Asia/Shanghai&#34;
	}

	if &#34;_grokparsefailure&#34; in [tags] {
		grok {
			match =&gt; {
				&#34;message&#34; =&gt; &#34;(?&lt;log_class&gt;(?:[a-zA-Z$_][a-zA-Z$_0-9]*\.*)*[a-zA-Z$_][a-zA-Z$_0-9]*)&#34;
			}
			add_field =&gt; {
				&#34;log_level&#34; =&gt; &#34;ERROR&#34;
				&#34;log_time&#34; =&gt; &#34;%{@timestamp}&#34;
				&#34;log_msg&#34; =&gt; &#34;%{message}&#34;
			}
		}
	}
}

output {
	elasticsearch {
		hosts =&gt; [&#34;127.0.0.1:9200&#34;]
		index =&gt; &#34;logstash-%{type}-%{+YYYY.MM.dd}&#34;
	}
}</code></pre></div>
<p>grok 语法测试工具 <a href="https://grokdebug.herokuapp.com/">https://grokdebug.herokuapp.com/</a></p>

<blockquote>
<p>非常遗憾的是, input redis 的 key 不支持正则, <a href="https://github.com/logstash-plugins/logstash-input-redis/issues/49">https://github.com/logstash-plugins/logstash-input-redis/issues/49</a></p>
</blockquote>

<h3 id="elasticsearch">ElasticSearch</h3>

<p>./config/elasticsearch.yml</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">path.data: /root/elk/data/es/data
path.logs: /root/elk/data/es/logs
network.host: <span style="color:#bd93f9">192.168.1.61</span>
http.port: <span style="color:#bd93f9">9200</span></code></pre></div>
<h4 id="其他配置项">其他配置项</h4>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html</a>
包含日志保存几天等</p>

<h4 id="note">Note</h4>

<p>因为es可以执行代码, 所以, 不能以root用户启动, 要新建一个专用的用户</p>

<pre><code>groupadd elsearch
useradd elsearch -g elsearch -p elasticsearch
</code></pre>

<h4 id="生产部署指引">生产部署指引</h4>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/hardware.html">https://www.elastic.co/guide/en/elasticsearch/guide/current/hardware.html</a>
总结一下,就是
1. 大内存(建议不超过64G, 不低于8G)
2. 普通CPU(双核就差不多了)
3. 高速硬盘</p>

<h3 id="kibana">kibana</h3>

<pre><code>server.port: 5601
server.host: &quot;192.168.1.61&quot;
elasticsearch.url: &quot;http://localhost:9200&quot;
</code></pre>

<h4 id="常用的搜索语法">常用的搜索语法</h4>

<ul>
<li>简单的搜索是使用 lucene 的语法 <a href="https://lucene.apache.org/core/2_9_4/queryparsersyntax.html">syntax</a></li>
<li>也可以使用 es 的搜索语法 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.4/query-dsl.html">es-dsl</a></li>
</ul>

<h5 id="简单搜索">简单搜索</h5>

<ol>
<li>直接输入查询关键字<code>key</code>, 返回所有可以索引字段值中包含key的文档</li>
<li>限定字段全文搜索<code>field:value</code>, 限定字段精确查找<code>field:&quot;value&quot;</code></li>
<li>使用正则表达式<code>field:/regex/</code></li>
<li>逻辑操作符<code>AND</code>, <code>OR</code> <code>+</code>: 搜索结果包含, <code>-</code>: 搜索结果不含</li>
<li>特殊字符 <code>+ - &amp;&amp; || ! () {} [] ^&quot; ~ * ? : \</code></li>
</ol>

<h5 id="使用es-dsl搜索">使用es-dsl搜索</h5>

<blockquote>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.4/query-dsl-query-string-query.html#query-string-syntax">https://www.elastic.co/guide/en/elasticsearch/reference/5.4/query-dsl-query-string-query.html#query-string-syntax</a></p>
</blockquote>

<h4 id="查看上下文">查看上下文</h4>

<p>以前kibana是不支持查看上下文的, 在某一个版本中加上了 <a href="https://github.com/elastic/kibana/pull/9198">kibana-9198</a></p>

<ul>
<li>先检索到具体的某一条</li>
<li>展开详情
<s>此处应该有图</s></li>
<li>View surrounding documents
<s>此处应该有图</s></li>
</ul>

<h3 id="参考资料">参考资料</h3>

<p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/index.html">https://www.elastic.co/guide/en/beats/filebeat/current/index.html</a>
<a href="https://www.elastic.co/guide/en/beats/filebeat/current/redis-output.html">https://www.elastic.co/guide/en/beats/filebeat/current/redis-output.html</a>
<a href="https://www.elastic.co/guide/en/logstash/current/index.html">https://www.elastic.co/guide/en/logstash/current/index.html</a>
<a href="https://www.elastic.co/guide/en/kibana/current/index.html">https://www.elastic.co/guide/en/kibana/current/index.html</a>
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a>
<a href="https://lucene.apache.org/core/2_9_4/queryparsersyntax.html">https://lucene.apache.org/core/2_9_4/queryparsersyntax.html</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
