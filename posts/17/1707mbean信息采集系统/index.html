<!doctype html>
<html lang="zh-cn">
  <head>
    <title>mbean信息采集系统 // hpeng526</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.59.1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="hpeng526" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://hpeng526.github.io/css/main.min.f90f5edd436ec7b74ad05479a05705770306911f721193e7845948fb07fe1335.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="mbean信息采集系统"/>
<meta name="twitter:description" content="mbean 信息采集系统 spring boot Actuator 这个不多讲，主要是利用 metrics 采集时间序列（time-series）数据，他也可以在 spring mvc 上使用，所以很容易在我们现有的系统上集"/>

    <meta property="og:title" content="mbean信息采集系统" />
<meta property="og:description" content="mbean 信息采集系统 spring boot Actuator 这个不多讲，主要是利用 metrics 采集时间序列（time-series）数据，他也可以在 spring mvc 上使用，所以很容易在我们现有的系统上集" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hpeng526.github.io/posts/17/1707mbean%E4%BF%A1%E6%81%AF%E9%87%87%E9%9B%86%E7%B3%BB%E7%BB%9F/" />
<meta property="article:published_time" content="2017-07-25T23:13:51+00:00" />
<meta property="article:modified_time" content="2017-07-25T23:13:51+00:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://hpeng526.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="hpeng526" /></a>
      <h1>hpeng526</h1>
      <p>Notes</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/hpeng526" rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">mbean信息采集系统</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jul 25, 2017
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          2 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://hpeng526.github.io/tags/spring/">spring</a><a class="tag" href="https://hpeng526.github.io/tags/jolokia/">jolokia</a><a class="tag" href="https://hpeng526.github.io/tags/telegraf/">Telegraf</a><a class="tag" href="https://hpeng526.github.io/tags/influxdb/">influxdb</a><a class="tag" href="https://hpeng526.github.io/tags/grafana/">Grafana</a><a class="tag" href="https://hpeng526.github.io/tags/mbeans/">MBeans</a></div></div>
    </header>
    <div class="post-content">
      

<h1 id="mbean-信息采集系统">mbean 信息采集系统</h1>

<h3 id="spring-boot-actuator">spring boot Actuator</h3>

<p>这个不多讲，主要是利用 <code>metrics</code> 采集时间序列（time-series）数据，他也可以在 spring mvc 上使用，所以很容易在我们现有的系统上集成。</p>

<!-- more -->

<h3 id="jolokia">jolokia</h3>

<p><a href="https://jolokia.org/">jolokia.org</a></p>

<p>简单点说，就是把 MBeans 以 RESTful HTTP 端点的方式暴露（json数据）。这就十分方便了，以前我们看 mbean 信息就只能通过 jconsole 啊之类的程序查看，其内部的实现都是非常重的 RMI 协议。其实 jolokia 也提供了非常多的方式方法来让我们通过浏览器查看当前应用注册的 mbean 信息，但是，如果要聚合一堆应用查看，这就不行了。</p>

<h3 id="telegraf">Telegraf</h3>

<p><a href="https://github.com/influxdata/telegraf">influxdata/telegraf</a></p>

<p>Telegraf 是一个用 Go 写的代理，用来收集，处理，聚合和写 metrics。 你可以把他类比 <code>filebeats</code>（Logstash）。这个工具呢，他有输入输出插件，输入插件可以读取jolokia数据, 输出插件可以把数据输出到 influxdb 上。</p>

<h3 id="influxdb">influxdb</h3>

<p><a href="https://www.influxdata.com/">influxdata</a></p>

<p>influxdb是目前比较流行的时间序列(time-series)数据库。</p>

<h4 id="什么是时间序列数据库">什么是时间序列数据库</h4>

<p>什么是时间序列数据库，最简单的定义就是数据格式里包含Timestamp字段的数据。时间序列数据的更重要的一个属性是如何去查询它，包括数据的过滤，计算等等。</p>

<p>它有以下几大特点：</p>

<ul>
<li>schemaless(无结构)，可以是任意数量的列；</li>
<li>min, max, sum, count, mean, median 一系列函数，方便统计；</li>
<li>Native HTTP API, 内置http支持，使用http读写；</li>
<li>Powerful Query Language 类似sql；</li>
</ul>

<h3 id="grafana">Grafana</h3>

<p>简单点，它是一个开源仪表盘工具，目前支持26种数据源。当然有 influxdb ，也支持 ES。把它类比 Kibana 就清楚它的作用了。</p>

<h3 id="拼凑原理">拼凑原理</h3>

<p>讲这么多，他们是怎么拼起来的？</p>

<ol>
<li><p>Spring Boot Actuator 可以与 jolokia 无缝集成，提供了官方的支持，具体的实现就是，通过它的 auto config （JolokiaAutoConfiguration.class），把 jolokia 的配置通过 actuator 的 endpoint 暴露出去。这样，我们就可以通过 URL 采集 web 应用的 mbean 信息了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">public class JolokiaMvcEndpoint extends AbstractNamedMvcEndpoint implements InitializingBean, ApplicationContextAware, ServletContextAware, DisposableBean {
    private final ServletWrappingController controller <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ServletWrappingController();

    public JolokiaMvcEndpoint() {
        <span style="color:#8be9fd;font-style:italic">super</span>(<span style="color:#f1fa8c">&#34;jolokia&#34;</span>, <span style="color:#f1fa8c">&#34;/jolokia&#34;</span>, <span style="color:#ff79c6">true</span>);
        <span style="color:#6272a4">// 这个 AgentServlet.class 是jolokia用来在应用中暴露自身 endpoint 使用的
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// spring boot actuator 将它注册到 spring mvc controller 中。
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// ServletWrappingController 将 Servlet 直接包装为一个 Controller
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">controller</span>.<span style="color:#50fa7b">setServletClass</span>(AgentServlet.<span style="color:#50fa7b">class</span>);
        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">controller</span>.<span style="color:#50fa7b">setServletName</span>(<span style="color:#f1fa8c">&#34;jolokia&#34;</span>);
    }
    <span style="color:#6272a4">/*..省略..*/</span>
}</code></pre></div></li>

<li><p>Telegraf 通过配置的需要采集的服务器信息，自动进行采集处理，并保存数据在 influxdb 中</p></li>

<li><p>Grafana 连接到 influxdb， 在页面定制（influxdb 的查询语句）要展示的图标，进行数据的展示。</p></li>
</ol>

<p>简单画个图，就是</p>

<pre><code>+---------+   /jolokia               +----------+
|  App 1  +-------------+            |          |
+---------+             |  telegraf  |          |
                        +-----------&gt;+ InfluxDB |
+---------+             |            |          |
|  App 2  +-------------+            |          |
+---------+                          +------+---+
                                            ^
                                fetch data  |
       +-------------------------------+    |
       |                               |    |
       |                               |    |
       |            Grafana            +----+
       |                               |
       |                               |
       +-------------------------------+
</code></pre>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
